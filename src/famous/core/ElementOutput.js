/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Owner: mark@famo.us
 * @license MPL 2.0
 * @copyright Famous Industries, Inc. 2014
 */

define(["require","exports","module","./Entity","./EventHandler","./Transform"],function(t,i,e){function n(t){this._matrix=null,this._opacity=1,this._origin=null,this._size=null,this._eventOutput=new _,this._eventOutput.bindThis(this),this.eventForwarder=function(t){this._eventOutput.emit(t.type,t)}.bind(this),this.id=u.register(this),this._element=null,this._sizeDirty=!1,this._originDirty=!1,this._transformDirty=!1,this._invisible=!1,t&&this.attach(t)}function s(t){for(var i in this._eventOutput.listeners)t.addEventListener(i,this.eventForwarder)}function r(t){for(var i in this._eventOutput.listeners)t.removeEventListener(i,this.eventForwarder)}function o(t){t[12]=Math.round(t[12]*y)/y,t[13]=Math.round(t[13]*y)/y;for(var i="matrix3d(",e=0;e<15;e++)i+=t[e]<1e-6&&t[e]>-1e-6?"0,":t[e]+",";return i+=t[15]+")"}function h(t){return 100*t[0]+"% "+100*t[1]+"%"}function a(t,i){return t&&i?t[0]!==i[0]||t[1]!==i[1]:t!==i}var u=t("./Entity"),_=t("./EventHandler"),l=t("./Transform"),p=void 0!==document.body.style.webkitTransform,y=window.devicePixelRatio||1;n.prototype.on=function(t,i){this._element&&this._element.addEventListener(t,this.eventForwarder),this._eventOutput.on(t,i)},n.prototype.removeListener=function(t,i){this._eventOutput.removeListener(t,i)},n.prototype.emit=function(t,i){i&&!i.origin&&(i.origin=this);var e=this._eventOutput.emit(t,i);return e&&i&&i.stopPropagation&&i.stopPropagation(),e},n.prototype.pipe=function(t){return this._eventOutput.pipe(t)},n.prototype.unpipe=function(t){return this._eventOutput.unpipe(t)},n.prototype.render=function(){return this.id};var f;f=navigator.userAgent.toLowerCase().indexOf("firefox")>-1?function(t,i){t.style.zIndex=1e6*i[14]|0,t.style.transform=o(i)}:p?function(t,i){t.style.webkitTransform=o(i)}:function(t,i){t.style.transform=o(i)};var c=p?function(t,i){t.style.webkitTransformOrigin=h(i)}:function(t,i){t.style.transformOrigin=h(i)},v=p?function(t){t.style.webkitTransform="scale3d(0.0001,0.0001,0.0001)",t.style.opacity=0}:function(t){t.style.transform="scale3d(0.0001,0.0001,0.0001)",t.style.opacity=0};n.prototype.commit=function(t){var i=this._element;if(i){var e=t.transform,n=t.opacity,s=t.origin,r=t.size;if(!e&&this._matrix)return this._matrix=null,this._opacity=0,void v(i);if(a(this._origin,s)&&(this._originDirty=!0),a(this._size,r)&&(this._sizeDirty=!0),l.notEquals(this._matrix,e)&&(this._transformDirty=!0),this._invisible&&(this._invisible=!1,this._element.style.display=""),this._opacity!==n&&(this._opacity=n,i.style.opacity=n>=1?"0.999999":n),this._transformDirty||this._originDirty||this._sizeDirty){this._sizeDirty&&(this._size||(this._size=[0,0]),this._size[0]=r[0],this._size[1]=r[1],this._sizeDirty=!1),this._originDirty&&(s?(this._origin||(this._origin=[0,0]),this._origin[0]=s[0],this._origin[1]=s[1]):this._origin=null,c(i,this._origin),this._originDirty=!1),e||(e=l.identity),this._matrix=e;var o=this._size?l.thenMove(e,[-this._size[0]*s[0],-this._size[1]*s[1],0]):e;f(i,o),this._transformDirty=!1}}},n.prototype.cleanup=function(){this._element&&(this._invisible=!0,this._element.style.display="none")},n.prototype.attach=function(t){this._element=t,s.call(this,t)},n.prototype.detach=function(){var t=this._element;return t&&(r.call(this,t),this._invisible&&(this._invisible=!1,this._element.style.display="")),this._element=null,t},e.exports=n});