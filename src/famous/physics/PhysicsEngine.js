/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * @license MPL 2.0
 * @copyright Famous Industries, Inc. 2014
 */

define(["require","exports","module","famous/core/EventHandler"],function(t,e,i){function n(t){this.options=Object.create(n.DEFAULT_OPTIONS),t&&this.setOptions(t),this._particles=[],this._bodies=[],this._agents={},this._forces=[],this._constraints=[],this._buffer=0,this._prevTime=E(),this._isSleeping=!1,this._eventHandler=null,this._currAgentId=0,this._hasBodies=!1}function s(t){return t.applyForce?this._forces:t.applyConstraint?this._constraints:void 0}function o(t,e,i){return void 0===e&&(e=this.getParticlesAndBodies()),e instanceof Array||(e=[e]),this._agents[this._currAgentId]={agent:t,targets:e,source:i},s.call(this,t).push(this._currAgentId),this._currAgentId++}function r(t){return this._agents[t]}function a(t){var e=r.call(this,this._forces[t]);e.agent.applyForce(e.targets,e.source)}function h(){for(var t=this._forces.length-1;t>-1;t--)a.call(this,t)}function c(t,e){var i=this._agents[this._constraints[t]];return i.agent.applyConstraint(i.targets,i.source,e)}function l(t){for(var e=0;e<this.options.constraintSteps;){for(var i=this._constraints.length-1;i>-1;i--)c.call(this,i,t);e++}}function p(t,e){t.integrateVelocity(e)}function u(t,e){t.integrateAngularMomentum(e),t.updateAngularVelocity()}function f(t,e){t.integrateOrientation(e)}function g(t,e){t.integratePosition(e),t.emit("update",t)}function _(t){h.call(this,t),this.forEach(p,t),this.forEachBody(u,t),l.call(this,t),this.forEachBody(f,t),this.forEach(g,t)}function d(){var t=0,e=0;return this.forEach(function(i){e=i.getEnergy(),t+=e,e<i.sleepTolerance&&i.sleep()}),t}function y(){for(var t=0,e=this._forces.length-1;e>-1;e--)t+=this._forces[e].getEnergy()||0;return t}function v(){for(var t=0,e=this._constraints.length-1;e>-1;e--)t+=this._constraints[e].getEnergy()||0;return t}var B=t("famous/core/EventHandler");n.DEFAULT_OPTIONS={constraintSteps:1,sleepTolerance:1e-7};var E=function(){return Date.now}();n.prototype.setOptions=function(t){for(var e in t)this.options[e]&&(this.options[e]=t[e])},n.prototype.addBody=function(t){return t._engine=this,t.isBody?(this._bodies.push(t),this._hasBodies=!0):this._particles.push(t),t},n.prototype.removeBody=function(t){var e=t.isBody?this._bodies:this._particles,i=e.indexOf(t);if(i>-1){for(var n=0;n<Object.keys(this._agents).length;n++)this.detachFrom(n,t);e.splice(i,1)}0===this.getBodies().length&&(this._hasBodies=!1)},n.prototype.attach=function(t,e,i){if(t instanceof Array){for(var n=[],s=0;s<t.length;s++)n[s]=o.call(this,t[s],e,i);return n}return o.call(this,t,e,i)},n.prototype.attachTo=function(t,e){r.call(this,t).targets.push(e)},n.prototype.detach=function(t){var e=this.getAgent(t),i=s.call(this,e),n=i.indexOf(t);i.splice(n,1),delete this._agents[t]},n.prototype.detachFrom=function(t,e){var i=r.call(this,t);if(i.source===e)this.detach(t);else{var n=i.targets,s=n.indexOf(e);s>-1&&n.splice(s,1)}},n.prototype.detachAll=function(){this._agents={},this._forces=[],this._constraints=[],this._currAgentId=0},n.prototype.getAgent=function(t){return r.call(this,t).agent},n.prototype.getParticles=function(){return this._particles},n.prototype.getBodies=function(){return this._bodies},n.prototype.getParticlesAndBodies=function(){return this.getParticles().concat(this.getBodies())},n.prototype.forEachParticle=function(t,e){for(var i=this.getParticles(),n=0,s=i.length;n<s;n++)t.call(this,i[n],e)},n.prototype.forEachBody=function(t,e){if(this._hasBodies)for(var i=this.getBodies(),n=0,s=i.length;n<s;n++)t.call(this,i[n],e)},n.prototype.forEach=function(t,e){this.forEachParticle(t,e),this.forEachBody(t,e)},n.prototype.getEnergy=function(){return d.call(this)+y.call(this)+v.call(this)},n.prototype.step=function(){var t=E(),e=t-this._prevTime;this._prevTime=t,e<1e3/120||(e>17&&(e=17),_.call(this,17))},n.prototype.isSleeping=function(){return this._isSleeping},n.prototype.sleep=function(){this.emit("end",this),this._isSleeping=!0},n.prototype.wake=function(){this._prevTime=E(),this.emit("start",this),this._isSleeping=!1},n.prototype.emit=function(t,e){null!==this._eventHandler&&this._eventHandler.emit(t,e)},n.prototype.on=function(t,e){null===this._eventHandler&&(this._eventHandler=new B),this._eventHandler.on(t,e)},i.exports=n});