/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Owner: david@famo.us
 * @license MPL 2.0
 * @copyright Famous Industries, Inc. 2014
 */

define(["require","exports","module","famous/math/Vector","famous/core/Transform","famous/core/EventHandler","../integrators/SymplecticEuler"],function(t,i,e){function o(t){t=t||{},this.position=new n,this.velocity=new n,this.force=new n;var i=o.DEFAULT_OPTIONS;this.setPosition(t.position||i.position),this.setVelocity(t.velocity||i.velocity),this.force.set(t.force||[0,0,0]),this.mass=void 0!==t.mass?t.mass:i.mass,this.axis=void 0!==t.axis?t.axis:i.axis,this.inverseMass=1/this.mass,this._isSleeping=!1,this._engine=null,this._eventOutput=null,this._positionGetter=null,this.transform=r.identity.slice(),this._spec={transform:this.transform,target:null}}function s(){this._eventOutput=new p,this._eventOutput.bindThis(this),p.setOutputHandler(this,this._eventOutput)}var n=t("famous/math/Vector"),r=t("famous/core/Transform"),p=t("famous/core/EventHandler"),h=t("../integrators/SymplecticEuler");o.DEFAULT_OPTIONS={position:[0,0,0],velocity:[0,0,0],mass:1,axis:void 0},o.SLEEP_TOLERANCE=1e-7,o.AXES={X:0,Y:1,Z:2},o.INTEGRATOR=new h;var u={start:"start",update:"update",end:"end"},a=function(){return Date.now}();o.prototype.sleep=function(){this._isSleeping||(this.emit(u.end,this),this._isSleeping=!0)},o.prototype.wake=function(){this._isSleeping&&(this.emit(u.start,this),this._isSleeping=!1,this._prevTime=a())},o.prototype.isBody=!1,o.prototype.setPosition=function(t){this.position.set(t)},o.prototype.setPosition1D=function(t){this.position.x=t},o.prototype.getPosition=function(){return this._positionGetter instanceof Function&&this.setPosition(this._positionGetter()),this._engine.step(),this.position.get()},o.prototype.getPosition1D=function(){return this._engine.step(),this.position.x},o.prototype.positionFrom=function(t){this._positionGetter=t},o.prototype.setVelocity=function(t){this.velocity.set(t),this.wake()},o.prototype.setVelocity1D=function(t){this.velocity.x=t,this.wake()},o.prototype.getVelocity=function(){return this.velocity.get()},o.prototype.getVelocity1D=function(){return this.velocity.x},o.prototype.setMass=function(t){this.mass=t,this.inverseMass=1/t},o.prototype.getMass=function(){return this.mass},o.prototype.reset=function(t,i){this.setPosition(t||[0,0,0]),this.setVelocity(i||[0,0,0])},o.prototype.applyForce=function(t){t.isZero()||(this.force.add(t).put(this.force),this.wake())},o.prototype.applyImpulse=function(t){if(!t.isZero()){var i=this.velocity;i.add(t.mult(this.inverseMass)).put(i)}},o.prototype.integrateVelocity=function(t){o.INTEGRATOR.integrateVelocity(this,t)},o.prototype.integratePosition=function(t){o.INTEGRATOR.integratePosition(this,t)},o.prototype._integrate=function(t){this.integrateVelocity(t),this.integratePosition(t)},o.prototype.getEnergy=function(){return.5*this.mass*this.velocity.normSquared()},o.prototype.getTransform=function(){this._engine.step();var t=this.position,i=this.axis,e=this.transform;return void 0!==i&&(i&~o.AXES.X&&(t.x=0),i&~o.AXES.Y&&(t.y=0),i&~o.AXES.Z&&(t.z=0)),e[12]=t.x,e[13]=t.y,e[14]=t.z,e},o.prototype.modify=function(t){var i=this._spec;return i.transform=this.getTransform(),i.target=t,i},o.prototype.emit=function(t,i){this._eventOutput&&this._eventOutput.emit(t,i)},o.prototype.on=function(){return s.call(this),this.on.apply(this,arguments)},o.prototype.removeListener=function(){return s.call(this),this.removeListener.apply(this,arguments)},o.prototype.pipe=function(){return s.call(this),this.pipe.apply(this,arguments)},o.prototype.unpipe=function(){return s.call(this),this.unpipe.apply(this,arguments)},e.exports=o});