/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Owner: felix@famo.us
 * @license MPL 2.0
 * @copyright Famous Industries, Inc. 2014
 */

define(["require","exports","module","famous/physics/PhysicsEngine","famous/physics/bodies/Particle","famous/physics/forces/Drag","famous/physics/forces/Spring","famous/core/EventHandler","famous/core/OptionsManager","famous/core/ViewSequence","famous/views/Scroller","famous/utilities/Utility","famous/inputs/GenericSync","famous/inputs/ScrollSync","famous/inputs/TouchSync"],function(t,i,s){function e(t){this.options=Object.create(e.DEFAULT_OPTIONS),this._optionsManager=new m(this.options),this._node=null,this._physicsEngine=new f,this._particle=new y,this._physicsEngine.addBody(this._particle),this.spring=new E({anchor:[0,0,0]}),this.drag=new S({forceFunction:S.FORCE_FUNCTIONS.QUADRATIC}),this.friction=new S({forceFunction:S.FORCE_FUNCTIONS.LINEAR}),this.sync=new C(["scroll","touch"],{direction:this.options.direction}),this._eventInput=new P,this._eventOutput=new P,this._eventInput.pipe(this.sync),this.sync.pipe(this._eventInput),P.setInputHandler(this,this._eventInput),P.setOutputHandler(this,this._eventOutput),this._touchCount=0,this._springState=w.NONE,this._onEdge=0,this._pageSpringPosition=0,this._edgeSpringPosition=0,this._touchVelocity=void 0,this._earlyEnd=!1,this._needsPaginationCheck=!1,this._scroller=new O,this._scroller.positionFrom(this.getPosition.bind(this)),this.setOptions(t),r.call(this)}function o(t){this._touchCount=t.count,void 0===t.count&&(this._touchCount=1),p.call(this),this.setVelocity(0),this._touchVelocity=0,this._earlyEnd=!1}function n(t){var i=-t.velocity,s=-t.delta;this._onEdge&&t.slip&&(i<0&&this._onEdge<0||i>0&&this._onEdge>0?this._earlyEnd||(h.call(this,t),this._earlyEnd=!0):this._earlyEnd&&Math.abs(i)>Math.abs(this.getVelocity())&&o.call(this,t)),this._earlyEnd||(this._touchVelocity=i,t.slip?this.setVelocity(i):this.setPosition(this.getPosition()+s))}function h(t){if(this._touchCount=t.count||0,!this._touchCount){p.call(this),this._onEdge&&g.call(this,this._edgeSpringPosition,w.EDGE),c.call(this);var i=-t.velocity,s=this.options.speedLimit;t.slip&&(s*=this.options.edgeGrip),i<-s?i=-s:i>s&&(i=s),this.setVelocity(i),this._touchVelocity=void 0,this._needsPaginationCheck=!0}}function r(){this._eventInput.bindThis(this),this._eventInput.on("start",o),this._eventInput.on("update",n),this._eventInput.on("end",h),this._scroller.on("edgeHit",function(t){this._edgeSpringPosition=t.position}.bind(this))}function c(){this._springState?this._physicsEngine.attach([this.spring],this._particle):this._physicsEngine.attach([this.drag,this.friction],this._particle)}function p(){this._springState=w.NONE,this._physicsEngine.detachAll()}function a(t){var i=this.options.direction,s=(t.getSize()||this._scroller.getSize())[i];return s||(s=this._scroller.getSize()[i]),s}function l(t){!this._onEdge&&t?(this.sync.setOptions({scale:this.options.edgeGrip}),this._touchCount||this._springState===w.EDGE||g.call(this,this._edgeSpringPosition,w.EDGE)):this._onEdge&&!t&&(this.sync.setOptions({scale:1}),this._springState&&Math.abs(this.getVelocity())<.001&&(p.call(this),c.call(this))),this._onEdge=t}function u(){if(this._needsPaginationCheck&&!this._touchCount&&this._springState!==w.EDGE){var t=this.getVelocity();if(!(Math.abs(t)>=this.options.pageStopSpeed)){var i=this.getPosition(),s=Math.abs(t)>this.options.pageSwitchSpeed,e=a.call(this,this._node),o=i>.5*e,n=t>0;o&&!s||s&&n?this.goToNextPage():g.call(this,0,w.PAGE),this._needsPaginationCheck=!1}}}function g(t,i){var s;i===w.EDGE?(this._edgeSpringPosition=t,s={anchor:[this._edgeSpringPosition,0,0],period:this.options.edgePeriod,dampingRatio:this.options.edgeDamp}):i===w.PAGE&&(this._pageSpringPosition=t,s={anchor:[this._pageSpringPosition,0,0],period:this.options.pagePeriod,dampingRatio:this.options.pageDamp}),this.spring.setOptions(s),i&&!this._springState&&(p.call(this),this._springState=i,c.call(this)),this._springState=i}function _(){for(var t=this.getPosition(),i=a.call(this,this._node),s=this._node.getNext();t>i+G&&s;)d.call(this,-i),t-=i,this._scroller.sequenceFrom(s),this._node=s,s=this._node.getNext(),i=a.call(this,this._node);for(var e,o=this._node.getPrevious();t<-G&&o;)e=a.call(this,o),this._scroller.sequenceFrom(o),this._node=o,d.call(this,e),t+=e,o=this._node.getPrevious()}function d(t){this._edgeSpringPosition+=t,this._pageSpringPosition+=t,this.setPosition(this.getPosition()+t),this._springState===w.EDGE?this.spring.setOptions({anchor:[this._edgeSpringPosition,0,0]}):this._springState===w.PAGE&&this.spring.setOptions({anchor:[this._pageSpringPosition,0,0]})}var f=t("famous/physics/PhysicsEngine"),y=t("famous/physics/bodies/Particle"),S=t("famous/physics/forces/Drag"),E=t("famous/physics/forces/Spring"),P=t("famous/core/EventHandler"),m=t("famous/core/OptionsManager"),v=t("famous/core/ViewSequence"),O=t("famous/views/Scroller"),D=t("famous/utilities/Utility"),C=t("famous/inputs/GenericSync"),I=t("famous/inputs/ScrollSync"),N=t("famous/inputs/TouchSync");C.register({scroll:I,touch:N});var G=.5,w={NONE:0,EDGE:1,PAGE:2};e.DEFAULT_OPTIONS={direction:D.Direction.Y,rails:!0,friction:.001,drag:1e-4,edgeGrip:.5,edgePeriod:300,edgeDamp:1,margin:1e3,paginated:!1,pagePeriod:500,pageDamp:.8,pageStopSpeed:10,pageSwitchSpeed:.5,speedLimit:10,groupScroll:!1},e.prototype.outputFrom=function(){return this._scroller.outputFrom.apply(this._scroller,arguments)},e.prototype.getPosition=function(){return this._particle.getPosition1D()},e.prototype.setPosition=function(t){this._particle.setPosition1D(t)},e.prototype.getVelocity=function(){return this._touchCount?this._touchVelocity:this._particle.getVelocity1D()},e.prototype.setVelocity=function(t){this._particle.setVelocity1D(t)},e.prototype.setOptions=function(t){t&&(void 0!==t.direction&&("x"===t.direction?t.direction=D.Direction.X:"y"===t.direction&&(t.direction=D.Direction.Y)),this._scroller.setOptions(t),this._optionsManager.setOptions(t)),this._scroller.setOptions(this.options),this.options.groupScroll?this._scroller.pipe(this._eventInput):this._scroller.unpipe(this._eventInput),this.drag.setOptions({strength:this.options.drag}),this.friction.setOptions({strength:this.options.friction}),this.spring.setOptions({period:this.options.edgePeriod,dampingRatio:this.options.edgeDamp}),this.sync.setOptions({rails:this.options.rails,direction:this.options.direction===D.Direction.X?C.DIRECTION_X:C.DIRECTION_Y})},e.prototype.goToPreviousPage=function(){if(!this._node)return null;var t=this._node.getPrevious();if(t){var i=this.getPosition(),s=a.call(this,t);this._scroller.sequenceFrom(t),this._node=t;var e=i<G?-s:0;g.call(this,e,w.PAGE),d.call(this,s)}return this._eventOutput.emit("pageChange",{direction:-1}),t},e.prototype.goToNextPage=function(){if(!this._node)return null;var t=this._node.getNext();if(t){var i=this.getPosition(),s=a.call(this,this._node),e=a.call(this,t);this._scroller.sequenceFrom(t),this._node=t;var o=i>s-G?s+e:s;g.call(this,o,w.PAGE),d.call(this,-s)}return this._eventOutput.emit("pageChange",{direction:1}),t},e.prototype.sequenceFrom=function(t){return t instanceof Array&&(t=new v({array:t})),this._node=t,this._scroller.sequenceFrom(t)},e.prototype.getSize=function(){return this._scroller.getSize.apply(this._scroller,arguments)},e.prototype.render=function(){return this._node?(_.call(this),l.call(this,this._scroller.onEdge()),this.options.paginated&&u.call(this),this._scroller.render()):null},s.exports=e});