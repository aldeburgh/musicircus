/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Owner: felix@famo.us
 * @license MPL 2.0
 * @copyright Famous Industries, Inc. 2014
 */

define(["require","exports","module","famous/core/Modifier","famous/core/RenderNode","famous/core/Transform","famous/transitions/Transitionable","famous/core/View"],function(t,i,n){function o(t){u.apply(this,arguments),this._showing=-1,this._outgoingRenderables=[],this._nextRenderable=null,this._renderables=[],this._nodes=[],this._modifiers=[],this._states=[],this.inTransformMap=o.DefaultMap.transform,this.inOpacityMap=o.DefaultMap.opacity,this.inOriginMap=o.DefaultMap.origin,this.outTransformMap=o.DefaultMap.transform,this.outOpacityMap=o.DefaultMap.opacity,this.outOriginMap=o.DefaultMap.origin,this._output=[]}function e(t,i){return t(i.get())}var s=t("famous/core/Modifier"),r=t("famous/core/RenderNode"),a=t("famous/core/Transform"),h=t("famous/transitions/Transitionable"),u=t("famous/core/View");o.prototype=Object.create(u.prototype),o.prototype.constructor=o,o.DEFAULT_OPTIONS={inTransition:!0,outTransition:!0,overlap:!0},o.DefaultMap={transform:function(){return a.identity},opacity:function(t){return t},origin:null},o.prototype.inTransformFrom=function(t){if(t instanceof Function)this.inTransformMap=t;else{if(!t||!t.get)throw new Error("inTransformFrom takes only function or getter object");this.inTransformMap=t.get.bind(t)}return this},o.prototype.inOpacityFrom=function(t){if(t instanceof Function)this.inOpacityMap=t;else{if(!t||!t.get)throw new Error("inOpacityFrom takes only function or getter object");this.inOpacityMap=t.get.bind(t)}return this},o.prototype.inOriginFrom=function(t){if(t instanceof Function)this.inOriginMap=t;else{if(!t||!t.get)throw new Error("inOriginFrom takes only function or getter object");this.inOriginMap=t.get.bind(t)}return this},o.prototype.outTransformFrom=function(t){if(t instanceof Function)this.outTransformMap=t;else{if(!t||!t.get)throw new Error("inTransformFrom takes only function or getter object");this.outTransformMap=t.get.bind(t)}return this},o.prototype.outOpacityFrom=function(t){if(t instanceof Function)this.outOpacityMap=t;else{if(!t||!t.get)throw new Error("inOpacityFrom takes only function or getter object");this.outOpacityMap=t.get.bind(t)}return this},o.prototype.outOriginFrom=function(t){if(t instanceof Function)this.outOriginMap=t;else{if(!t||!t.get)throw new Error("inOriginFrom takes only function or getter object");this.outOriginMap=t.get.bind(t)}return this},o.prototype.show=function(t,i,n){if(!t)return this.hide(n);if(i instanceof Function&&(n=i,i=null),this._showing>=0){if(!this.options.overlap)return void(this._nextRenderable?this._nextRenderable=t:(this._nextRenderable=t,this.hide(function(){this._nextRenderable===t&&this.show(this._nextRenderable,n),this._nextRenderable=null})));this.hide()}var o=null,a=this._renderables.indexOf(t);if(a>=0){this._showing=a,o=this._states[a],o.halt();var u=this._outgoingRenderables.indexOf(t);u>=0&&this._outgoingRenderables.splice(u,1)}else{o=new h(0);var p=new s({transform:this.inTransformMap?e.bind(this,this.inTransformMap,o):null,opacity:this.inOpacityMap?e.bind(this,this.inOpacityMap,o):null,origin:this.inOriginMap?e.bind(this,this.inOriginMap,o):null}),f=new r;f.add(p).add(t),this._showing=this._nodes.length,this._nodes.push(f),this._modifiers.push(p),this._states.push(o),this._renderables.push(t)}i||(i=this.options.inTransition),o.set(1,i,n)},o.prototype.hide=function(t,i){if(!(this._showing<0)){var n=this._showing;this._showing=-1,t instanceof Function&&(i=t,t=void 0);var o=this._nodes[n],s=this._modifiers[n],r=this._states[n],a=this._renderables[n];s.transformFrom(this.outTransformMap?e.bind(this,this.outTransformMap,r):null),s.opacityFrom(this.outOpacityMap?e.bind(this,this.outOpacityMap,r):null),s.originFrom(this.outOriginMap?e.bind(this,this.outOriginMap,r):null),this._outgoingRenderables.indexOf(a)<0&&this._outgoingRenderables.push(a),t||(t=this.options.outTransition),r.halt(),r.set(0,t,function(t,n,o,e){if(this._outgoingRenderables.indexOf(e)>=0){var s=this._nodes.indexOf(t);this._nodes.splice(s,1),this._modifiers.splice(s,1),this._states.splice(s,1),this._renderables.splice(s,1),this._outgoingRenderables.splice(this._outgoingRenderables.indexOf(e),1),this._showing>=s&&this._showing--}i&&i.call(this)}.bind(this,o,s,r,a))}},o.prototype.render=function(){var t=this._output;t.length>this._nodes.length&&t.splice(this._nodes.length);for(var i=0;i<this._nodes.length;i++)t[i]=this._nodes[i].render();return t},n.exports=o});