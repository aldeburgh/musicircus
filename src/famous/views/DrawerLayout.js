/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Owner: david@famo.us
 * @license MPL 2.0
 * @copyright Famous Industries, Inc. 2014
 */

define(["require","exports","module","famous/core/RenderNode","famous/core/Transform","famous/core/OptionsManager","famous/transitions/Transitionable","famous/core/EventHandler"],function(t,i,e){function n(t){this.options=Object.create(n.DEFAULT_OPTIONS),this._optionsManager=new u(this.options),t&&this.setOptions(t),this._position=new d(0),this._direction=s(this.options.side),this._orientation=o(this.options.side),this._isOpen=!1,this._cachedLength=0,this.drawer=new p,this.content=new p,this._eventInput=new _,this._eventOutput=new _,_.setInputHandler(this,this._eventInput),_.setOutputHandler(this,this._eventOutput),this._eventInput.on("update",h.bind(this)),this._eventInput.on("end",a.bind(this))}function s(t){var i=n.SIDES;return t===i.LEFT||t===i.RIGHT?f:O}function o(t){var i=n.SIDES;return t===i.LEFT||t===i.TOP?1:-1}function r(t){var i,e=this.options;if(e.drawerLength)i=e.drawerLength;else{var n=t.getSize();i=n?n[this._direction]:e.drawerLength}return this._orientation*i}function h(t){var i,e,n=this.getPosition()+t.delta;this._cachedLength=r.call(this,this.drawer),1===this._orientation?(i=0,e=this._cachedLength):(i=this._cachedLength,e=0),n>e?n=e:n<i&&(n=i),this.setPosition(n)}function a(t){var i=t.velocity,e=this._orientation*this.getPosition(),n=this.options,s=this._orientation*this._cachedLength,o=n.positionThreshold||s/2,r=n.velocityThreshold;return n.transition instanceof Object&&(n.transition.velocity=t.velocity),0===e?void(this._isOpen=!1):e===s?void(this._isOpen=!0):void(Math.abs(i)>r||!this._isOpen&&e>o||this._isOpen&&e<o?this.toggle():this.reset())}var p=t("famous/core/RenderNode"),c=t("famous/core/Transform"),u=t("famous/core/OptionsManager"),d=t("famous/transitions/Transitionable"),_=t("famous/core/EventHandler"),f=0,O=1;n.SIDES={LEFT:0,TOP:1,RIGHT:2,BOTTOM:3},n.DEFAULT_OPTIONS={side:n.SIDES.LEFT,drawerLength:0,velocityThreshold:0,positionThreshold:0,transition:!0},n.prototype.setOptions=function(t){this._optionsManager.setOptions(t),void 0!==t.side&&(this._direction=s(t.side),this._orientation=o(t.side))},n.prototype.open=function(t,i){t instanceof Function&&(i=t),void 0===t&&(t=this.options.transition),this._cachedLength=r.call(this,this.drawer),this.setPosition(this._cachedLength,t,i),this._isOpen||(this._isOpen=!0,this._eventOutput.emit("open"))},n.prototype.close=function(t,i){t instanceof Function&&(i=t),void 0===t&&(t=this.options.transition),this.setPosition(0,t,i),this._isOpen&&(this._isOpen=!1,this._eventOutput.emit("close"))},n.prototype.setPosition=function(t,i,e){this._position.isActive()&&this._position.halt(),this._position.set(t,i,e)},n.prototype.getPosition=function(){return this._position.get()},n.prototype.setProgress=function(t,i,e){return this._position.set(t*this._cachedLength,i,e)},n.prototype.getProgress=function(){return this._position.get()/this._cachedLength},n.prototype.toggle=function(t){this._isOpen?this.close(t):this.open(t)},n.prototype.reset=function(t){this._isOpen?this.open(t):this.close(t)},n.prototype.isOpen=function(t){return this._isOpen},n.prototype.render=function(){var t=this.getPosition();(!this._isOpen&&t<0&&1===this._orientation||t>0&&-1===this._orientation)&&(t=0,this.setPosition(t));var i=this._direction===f?c.translate(t,0,0):c.translate(0,t,0);return[{transform:c.behind,target:this.drawer.render()},{transform:i,target:this.content.render()}]},e.exports=n});